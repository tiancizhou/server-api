<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—è´¦å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 
                         'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            padding: 12px 15px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            font-size: 15px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        td {
            font-size: 14px;
            color: #1f2937;
        }

        tr:hover {
            background: #f9fafb;
        }

        .message {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’° ç®—è´¦å·¥å…·</h1>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="card">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">æ€»æˆæœ¬</div>
                    <div class="stat-value" id="totalCost">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»é”€å”®é¢</div>
                    <div class="stat-value" id="totalSales">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç›ˆåˆ©</div>
                    <div class="stat-value" id="profit">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å‰©ä½™å¡ç‰‡</div>
                    <div class="stat-value" id="remainingCards">0 å¼ </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="message"></div>

        <!-- è¿›è´§è®°å½• -->
        <div class="card">
            <div class="section-title">
                <span>ğŸ“¦ è¿›è´§è®°å½•</span>
            </div>
            <form id="purchaseForm" onsubmit="addPurchase(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="purchaseDate" required>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¢ (Â¥)</label>
                        <input type="number" step="0.01" id="purchaseAmount" placeholder="420" required>
                    </div>
                    <div class="form-group">
                        <label>å¡ç‰‡æ•°é‡ (å¼ )</label>
                        <input type="number" id="purchaseCardCount" placeholder="200" required>
                    </div>
                    <div class="form-group">
                        <label>æ¸ é“è´¹ç”¨ (Â¥)</label>
                        <input type="number" step="0.01" id="purchaseChannelFee" placeholder="200" value="0">
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="purchaseNote" placeholder="å¯é€‰">
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <label style="opacity: 0;">æäº¤</label>
                        <button type="submit" class="btn btn-primary">æ·»åŠ è¿›è´§</button>
                    </div>
                </div>
            </form>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é‡‘é¢</th>
                            <th>å¡ç‰‡æ•°</th>
                            <th>æ¸ é“è´¹</th>
                            <th>æ€»æˆæœ¬</th>
                            <th>å¤‡æ³¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="purchasesTable">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <div>æš‚æ— è¿›è´§è®°å½•</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- é”€å”®è®°å½• -->
        <div class="card">
            <div class="section-title">
                <span>ğŸ’µ é”€å”®è®°å½•</span>
            </div>
            <form id="saleForm" onsubmit="addSale(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="saleDate" required>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¢ (Â¥)</label>
                        <input type="number" step="0.01" id="saleAmount" placeholder="681.71" required>
                    </div>
                    <div class="form-group">
                        <label>å”®å‡ºå¡ç‰‡æ•° (å¼ )</label>
                        <input type="number" id="saleCardCount" placeholder="å¯é€‰ï¼Œç”¨äºè®¡ç®—å‰©ä½™å¡ç‰‡">
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="saleNote" placeholder="å¯é€‰">
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <label style="opacity: 0;">æäº¤</label>
                        <button type="submit" class="btn btn-primary">æ·»åŠ é”€å”®</button>
                    </div>
                </div>
            </form>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é‡‘é¢</th>
                            <th>å”®å‡ºå¡ç‰‡</th>
                            <th>å¤‡æ³¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="salesTable">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <div>æš‚æ— é”€å”®è®°å½•</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å…¶ä»–è´¹ç”¨ -->
        <div class="card">
            <div class="section-title">
                <span>ğŸ’¸ å…¶ä»–è´¹ç”¨</span>
            </div>
            <form id="expenseForm" onsubmit="addExpense(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¢ (Â¥)</label>
                        <input type="number" step="0.01" id="expenseAmount" placeholder="12" required>
                    </div>
                    <div class="form-group">
                        <label>è¯´æ˜</label>
                        <input type="text" id="expenseDescription" placeholder="æœåŠ¡å™¨ã€ä¼šå‘˜ç­‰">
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <label style="opacity: 0;">æäº¤</label>
                        <button type="submit" class="btn btn-primary">æ·»åŠ è´¹ç”¨</button>
                    </div>
                </div>
            </form>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é‡‘é¢</th>
                            <th>è¯´æ˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTable">
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <div>æš‚æ— è´¹ç”¨è®°å½•</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('purchaseDate').valueAsDate = new Date();
        document.getElementById('saleDate').valueAsDate = new Date();
        document.getElementById('expenseDate').valueAsDate = new Date();

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // å…ˆè·å–ç»Ÿè®¡ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†é¡µ
                const response = await fetch('/api/accounting/data');
                const result = await response.json();
                if (result.success) {
                    renderData(result.data);
                    updateStatistics(result.statistics);
                    
                    // å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œæ˜¾ç¤ºæç¤º
                    if (result.stats && result.stats.totalRecords > 5000) {
                        console.log(`æ•°æ®é‡è¾ƒå¤§: ${result.stats.totalRecords} æ¡è®°å½•ï¼Œå·²å¯ç”¨æ€§èƒ½ä¼˜åŒ–`);
                    }
                }
            } catch (error) {
                showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“æ•°æ®
        function renderData(data) {
            renderPurchases(data.purchases);
            renderSales(data.sales);
            renderExpenses(data.otherExpenses);
        }

        // æ¸²æŸ“è¿›è´§è®°å½•
        function renderPurchases(purchases) {
            const tbody = document.getElementById('purchasesTable');
            if (purchases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div>æš‚æ— è¿›è´§è®°å½•</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = purchases.map(p => {
                const totalCost = p.amount + (p.channelFee || 0);
                return `
                    <tr>
                        <td>${p.date}</td>
                        <td>Â¥${p.amount.toFixed(2)}</td>
                        <td>${p.cardCount} å¼ </td>
                        <td>Â¥${(p.channelFee || 0).toFixed(2)}</td>
                        <td>Â¥${totalCost.toFixed(2)}</td>
                        <td>${p.note || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deletePurchase('${p.id}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ¸²æŸ“é”€å”®è®°å½•
        function renderSales(sales) {
            const tbody = document.getElementById('salesTable');
            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div>æš‚æ— é”€å”®è®°å½•</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sales.map(s => {
                return `
                    <tr>
                        <td>${s.date}</td>
                        <td>Â¥${s.amount.toFixed(2)}</td>
                        <td>${s.cardCount || 0} å¼ </td>
                        <td>${s.note || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteSale('${s.id}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ¸²æŸ“è´¹ç”¨è®°å½•
        function renderExpenses(expenses) {
            const tbody = document.getElementById('expensesTable');
            if (expenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div>æš‚æ— è´¹ç”¨è®°å½•</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = expenses.map(e => {
                return `
                    <tr>
                        <td>${e.date}</td>
                        <td>Â¥${e.amount.toFixed(2)}</td>
                        <td>${e.description || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteExpense('${e.id}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics(stats) {
            document.getElementById('totalCost').textContent = 'Â¥' + stats.totalCost.toFixed(2);
            document.getElementById('totalSales').textContent = 'Â¥' + stats.totalSales.toFixed(2);
            
            const profitEl = document.getElementById('profit');
            profitEl.textContent = 'Â¥' + stats.profit.toFixed(2);
            profitEl.className = 'stat-value ' + (stats.profit >= 0 ? 'positive' : 'negative');
            
            document.getElementById('remainingCards').textContent = stats.remainingCards + ' å¼ ';
        }

        // æ·»åŠ è¿›è´§
        async function addPurchase(event) {
            event.preventDefault();
            const date = document.getElementById('purchaseDate').value;
            const amount = document.getElementById('purchaseAmount').value;
            const cardCount = document.getElementById('purchaseCardCount').value;
            const channelFee = document.getElementById('purchaseChannelFee').value || 0;
            const note = document.getElementById('purchaseNote').value;

            try {
                const response = await fetch('/api/accounting/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, amount, cardCount, channelFee, note })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('è¿›è´§è®°å½•æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('purchaseForm').reset();
                    document.getElementById('purchaseDate').valueAsDate = new Date();
                    loadData();
                } else {
                    showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ·»åŠ é”€å”®
        async function addSale(event) {
            event.preventDefault();
            const date = document.getElementById('saleDate').value;
            const amount = document.getElementById('saleAmount').value;
            const cardCount = document.getElementById('saleCardCount').value || 0;
            const note = document.getElementById('saleNote').value;

            try {
                const response = await fetch('/api/accounting/sale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, amount, cardCount, note })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('é”€å”®è®°å½•æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('saleForm').reset();
                    document.getElementById('saleDate').valueAsDate = new Date();
                    loadData();
                } else {
                    showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ·»åŠ è´¹ç”¨
        async function addExpense(event) {
            event.preventDefault();
            const date = document.getElementById('expenseDate').value;
            const amount = document.getElementById('expenseAmount').value;
            const description = document.getElementById('expenseDescription').value;

            try {
                const response = await fetch('/api/accounting/expense', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, amount, description })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('è´¹ç”¨è®°å½•æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('expenseForm').reset();
                    document.getElementById('expenseDate').valueAsDate = new Date();
                    loadData();
                } else {
                    showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤è¿›è´§
        async function deletePurchase(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¿›è´§è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/accounting/purchase/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadData();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤é”€å”®
        async function deleteSale(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é”€å”®è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/accounting/sale/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadData();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤è´¹ç”¨
        async function deleteExpense(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¹ç”¨è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/accounting/expense/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadData();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message message-${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        loadData();
    </script>
</body>
</html>

